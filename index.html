<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Second Pay</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f5f5f5;text-align:center}
header{background:#00A0E9;color:#fff;padding:16px;font-size:22px;font-weight:bold}
.box{background:#fff;margin:12px;padding:18px;border-radius:16px}
.big{font-size:30px;font-weight:bold}
.main-btn{width:95%;padding:20px;font-size:26px;border:none;border-radius:18px;background:#00A0E9;color:#fff}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:12px}
.grid button{padding:16px;font-size:18px;border-radius:14px;background:#fff;border:2px solid #00A0E9;color:#00A0E9;font-weight:bold}
.hidden{display:none}
.list{background:#eefaff;margin:8px;padding:10px;border-radius:10px}
</style>
</head>

<body>

<header>Second Pay</header>

<!-- ãƒ›ãƒ¼ãƒ  -->
<div id="home">
  <div class="box big">
    æ®‹é«˜<br><span id="balance">0</span>å††
  </div>

  <button class="main-btn" onclick="openPay()">æ”¯æ‰•ã†</button>

  <div class="grid">
    <button onclick="show('charge')">â•<br>ãƒãƒ£ãƒ¼ã‚¸</button>
    <button onclick="show('pending')">â³<br>ä»˜ä¸äºˆå®š</button>
    <button onclick="show('lottery')">ğŸ¯<br>æ¯æ—¥ãã˜</button>
    <button onclick="show('history')">ğŸ“„<br>å±¥æ­´</button>
  </div>
</div>

<!-- æ”¯æ‰•ã„ -->
<div id="pay" class="hidden">
  <video id="camera" width="300" autoplay></video>
  <p>é‡‘é¡ï¼š<span id="payAmount">---</span>å††</p>
  <button class="main-btn" id="payBtn" onclick="pay()" disabled>æ”¯æ‰•ã„ç¢ºå®š</button>
  <br><br>
  <button onclick="closePay()">æˆ»ã‚‹</button>
</div>

<!-- ãƒãƒ£ãƒ¼ã‚¸ -->
<div id="charge" class="hidden">
  <div class="box">
    <button class="main-btn" onclick="openATM()">ATMãƒãƒ£ãƒ¼ã‚¸</button><br><br>
    <button class="main-btn" onclick="show('gift')">ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰</button>
  </div>
  <button onclick="show('home')">æˆ»ã‚‹</button>
</div>

<!-- ATMãƒãƒ£ãƒ¼ã‚¸ -->
<div id="atm" class="hidden">
  <video id="atmCam" width="300" autoplay></video>
  <p>QRï¼š+1000 ã§ãƒãƒ£ãƒ¼ã‚¸</p>
  <button onclick="closeATM()">æˆ»ã‚‹</button>
</div>

<!-- ã‚®ãƒ•ãƒˆ -->
<div id="gift" class="hidden">
  <input id="giftInput" placeholder="XXXX-XXXX-0000-1000"><br><br>
  <input id="giftPass" type="password" placeholder="ç®¡ç†PW"><br><br>
  <button class="main-btn" onclick="gift()">ãƒãƒ£ãƒ¼ã‚¸</button>
  <br><br>
  <button onclick="show('charge')">æˆ»ã‚‹</button>
</div>

<!-- ä»˜ä¸äºˆå®š -->
<div id="pending" class="hidden">
  <div id="pendingList"></div>
  <button onclick="show('home')">æˆ»ã‚‹</button>
</div>

<!-- ãã˜ -->
<div id="lottery" class="hidden">
  <button class="main-btn" onclick="lottery()">ãã˜ã‚’å¼•ã</button>
  <br><br>
  <button onclick="show('home')">æˆ»ã‚‹</button>
</div>

<!-- å±¥æ­´ -->
<div id="history" class="hidden">
  <div id="historyList"></div>
  <button onclick="show('home')">æˆ»ã‚‹</button>
</div>

<script>
/* ===== è¨­å®š ===== */
const API = "https://script.google.com/macros/s/AKfycbwmj1UVvaUOWx7y2p3ogvOZ8PQo-oL-jR0lIiaQnwEOEljcuyGbCdJKZp_7qbDL-4sM/exec";
const ADMIN = "21310511";

/* ===== çŠ¶æ…‹ ===== */
let balance = 0;
let coupons = [];
let history = [];
let pendingCashback = [];
let lastLottery = "";
let stream = null;
let atmStream = null;
let payValue = 0;

/* ===== DOM ===== */
const balanceEl = document.getElementById("balance");
const historyList = document.getElementById("historyList");
const pendingList = document.getElementById("pendingList");

/* ===== ç”»é¢åˆ‡æ›¿ ===== */
function show(id){
  document.querySelectorAll("body>div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ===== èª­ã¿è¾¼ã¿ ===== */
function load(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      balance = d.balance;
      coupons = d.coupons || [];
      history = d.history || [];
      pendingCashback = d.pendingCashback || [];
      lastLottery = d.lastLottery || "";
      update();
    })
    .catch(e=>alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼"));
}

function save(){
  fetch(API,{
    method:"POST",
    headers:{
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      balance,
      coupons,
      history,
      pendingCashback,
      lastLottery
    })
  });
}

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function update(){
  balanceEl.textContent = balance;
  historyList.innerHTML = history.map(h=>`<div class="list">${h}</div>`).join("");
  pendingList.innerHTML = pendingCashback.length
    ? pendingCashback.map(p=>`<div class="list">${p.amount}å††ï¼ˆäºˆå®šï¼‰</div>`).join("")
    : "<p>ä»˜ä¸äºˆå®šãªã—</p>";
}

/* ===== æ”¯æ‰•ã„ï¼ˆ10%é‚„å…ƒï¼‰ ===== */
async function openPay(){
  show("pay");
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  camera.srcObject = stream;
  scan(camera, v=>{
    payValue = Number(v);
    payAmount.textContent = payValue;
    payBtn.disabled = false;
  });
}

function pay(){
  if(balance < payValue) return alert("æ®‹é«˜ä¸è¶³");
  balance -= payValue;
  const cb = Math.floor(payValue * 0.1);
  pendingCashback.push({amount:cb, date:new Date().toISOString()});
  history.unshift(`æ”¯æ‰•ã„ -${payValue}å††ï¼ˆé‚„å…ƒäºˆå®š ${cb}å††ï¼‰`);
  save(); update(); closePay();
}

function closePay(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  show("home");
}

/* ===== ATMãƒãƒ£ãƒ¼ã‚¸ ===== */
async function openATM(){
  show("atm");
  atmStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  atmCam.srcObject = atmStream;
  scan(atmCam, v=>{
    if(v === "+1000"){
      balance += 1000;
      history.unshift("ATMãƒãƒ£ãƒ¼ã‚¸ +1000å††");
      save(); update(); closeATM();
    }
  });
}

function closeATM(){
  if(atmStream) atmStream.getTracks().forEach(t=>t.stop());
  show("charge");
}

/* ===== QRå…±é€š ===== */
function scan(video, cb){
  const c = document.createElement("canvas");
  const x = c.getContext("2d");
  c.width = c.height = 300;

  (function loop(){
    x.drawImage(video,0,0,300,300);
    const i = x.getImageData(0,0,300,300);
    const q = jsQR(i.data,300,300);
    if(q) return cb(q.data);
    requestAnimationFrame(loop);
  })();
}

/* ===== ã‚®ãƒ•ãƒˆ ===== */
function gift(){
  if(giftPass.value !== ADMIN) return alert("PWé•ã„");
  const m = giftInput.value.match(/-(\d{4})$/);
  if(!m) return alert("å½¢å¼ã‚¨ãƒ©ãƒ¼");
  const a = Number(m[1]);
  balance += a;
  history.unshift(`ã‚®ãƒ•ãƒˆ +${a}å††`);
  save(); update(); show("home");
}

/* ===== æ¯æ—¥ãã˜ ===== */
function lottery(){
  const d = new Date().toDateString();
  if(d === lastLottery) return alert("ä»Šæ—¥ã¯æ¸ˆã¿");
  lastLottery = d;
  const r = Math.random()*100;
  const a = r<5?2000:r<25?1000:r<70?500:100;
  balance += a;
  history.unshift(`ãã˜ +${a}å††`);
  save(); update();
}

window.onload = load;
</script>

</body>
</html>
