<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Second Pay</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
body{font-family:Arial;background:#f5f5f5;margin:0;text-align:center}
header{background:#00A0E9;color:#fff;padding:20px;font-size:24px;font-weight:bold}
#balanceBox{background:#fff;margin:20px;padding:20px;border-radius:12px;font-size:28px;font-weight:bold}
button{width:80%;padding:15px;margin:10px;font-size:22px;background:#00A0E9;color:#fff;border:none;border-radius:10px}
#scannerArea,#giftArea,#couponArea,#lotteryArea,#historyArea{display:none}
.coupon{background:#e0f7ff;margin:10px;padding:10px;border-radius:8px}
</style>
</head>
<body>

<header>Second Pay</header>

<div id="homeArea">
  <div id="balanceBox">残高：<span id="balance">0</span>円</div>
  <button onclick="openPay()">支払う</button>
  <button onclick="show('giftArea')">ギフトコード</button>
  <button onclick="show('couponArea')">クーポン</button>
  <button onclick="show('lotteryArea')">ログインくじ</button>
  <button onclick="show('historyArea')">取引履歴</button>
</div>

<div id="scannerArea">
  <video id="camera" width="300" autoplay></video>
  <p>金額：<span id="payAmount">---</span>円</p>
  <button id="payBtn" onclick="pay()" disabled>支払い確定</button>
  <button onclick="closePay()">戻る</button>
</div>

<div id="giftArea">
  <input id="giftInput" placeholder="XXXX-XXXX-0000-1000">
  <input id="giftPass" type="password" placeholder="管理PW">
  <button onclick="gift()">チャージ</button>
  <button onclick="show('homeArea')">戻る</button>
</div>

<div id="couponArea">
  <input id="couponInput" placeholder="XXXX-XXXX-0000-0100">
  <input id="couponPass" type="password" placeholder="管理PW">
  <button onclick="addCoupon()">追加</button>
  <div id="couponList"></div>
  <button onclick="show('homeArea')">戻る</button>
</div>

<div id="lotteryArea">
  <button onclick="lottery()">くじを引く</button>
  <button onclick="show('homeArea')">戻る</button>
</div>

<div id="historyArea">
  <div id="historyList"></div>
  <button onclick="show('homeArea')">戻る</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzYzlqqA7kEgWKQd9hLgIGk1ipGCT5_wAwYNfv7rENe8E6-RS7o0avC_A6TYLFFqzfo/exec";
const ADMIN="21310511";

let balance=0,coupons=[],history=[],lastLottery="";
let stream,payValue=0;

function show(id){
  document.querySelectorAll('[id$=Area]').forEach(e=>e.style.display="none");
  document.getElementById(id).style.display="block";
}

function load(){
  fetch(API).then(r=>r.json()).then(d=>{
    balance=Number(d.balance)||0;
    coupons=d.coupons||[];
    history=d.history||[];
    lastLottery=d.lastLottery||"";
    update();
  }).catch(()=>update());
}

function save(){
  fetch(API,{method:"POST",body:JSON.stringify({balance,coupons,history,lastLottery})});
}

function update(){
  balanceEl.textContent=balance;
  historyList.innerHTML=history.map(h=>`<div>${h}</div>`).join("");
  couponList.innerHTML=coupons.map((c,i)=>`<div class=coupon>${c}円 <button onclick="delCoupon(${i})">削除</button></div>`).join("");
}

function gift(){
  if(giftPass.value!==ADMIN)return alert("PW違い");
  let m=giftInput.value.match(/-(\d{4})$/);
  if(!m)return;
  let a=Number(m[1]);
  balance+=a;
  history.unshift(`ギフト +${a}`);
  save();update();show("homeArea");
}

function addCoupon(){
  if(couponPass.value!==ADMIN)return;
  let m=couponInput.value.match(/-(\d{4})$/);
  if(!m)return;
  coupons.push(Number(m[1]));
  save();update();
}

function delCoupon(i){coupons.splice(i,1);save();update();}

function lottery(){
  let t=new Date().toDateString();
  if(t===lastLottery)return alert("今日は済み");
  lastLottery=t;
  let r=Math.random()*100;
  let a=r<3?2000:r<18?1000:r<68?500:100;
  balance+=a;
  history.unshift(`くじ +${a}`);
  save();update();
}

async function openPay(){
  show("scannerArea");
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  camera.srcObject=stream;
  scan();
}

function closePay(){stop();show("homeArea");}

function stop(){if(stream)stream.getTracks().forEach(t=>t.stop());}

function scan(){
  const c=document.createElement("canvas"),x=c.getContext("2d");
  c.width=c.height=300;
  (function loop(){
    if(scannerArea.style.display==="none")return;
    x.drawImage(camera,0,0,300,300);
    let i=x.getImageData(0,0,300,300);
    let q=jsQR(i.data,300,300);
    if(q){
      payValue=Number(q.data);
      payAmount.textContent=payValue;
      payBtn.disabled=false;
      return;
    }
    requestAnimationFrame(loop);
  })();
}

function pay(){
  if(balance<payValue)return alert("残高不足");
  balance-=payValue;
  history.unshift(`支払い -${payValue}`);
  save();update();closePay();
}

const balanceEl=document.getElementById("balance");
window.onload=load;
</script>
</body>
</html>
