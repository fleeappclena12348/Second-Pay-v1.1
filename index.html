<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Second Pay</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0;text-align:center}
header{background:#00A0E9;color:#fff;padding:18px;font-size:24px;font-weight:bold}

#homeArea{padding:15px}
#balanceBox{
  background:#fff;margin:15px;padding:20px;
  border-radius:16px;font-size:32px;font-weight:bold
}
.pay-main-btn{
  width:95%;padding:22px;margin:15px auto;
  font-size:28px;background:#00A0E9;color:#fff;
  border:none;border-radius:18px
}
.grid{
  display:grid;grid-template-columns:repeat(2,1fr);
  gap:14px;margin:10px
}
.grid button{
  padding:20px 5px;font-size:18px;border-radius:16px;
  background:#fff;color:#00A0E9;border:2px solid #00A0E9;
  font-weight:bold
}

#scannerArea,#giftArea,#couponArea,#lotteryArea,#historyArea{display:none}
.coupon{background:#e0f7ff;margin:10px;padding:10px;border-radius:8px}
</style>
</head>

<body>

<header>Second Pay</header>

<!-- ãƒ›ãƒ¼ãƒ  -->
<div id="homeArea">
  <div id="balanceBox">
    æ®‹é«˜<br>
    <span id="balance">0</span>å††
  </div>

  <button class="pay-main-btn" onclick="openPay()">æ”¯æ‰•ã†</button>

  <div class="grid">
    <button onclick="show('giftArea')">ğŸ<br>ã‚®ãƒ•ãƒˆ</button>
    <button onclick="show('couponArea')">ğŸ·<br>ã‚¯ãƒ¼ãƒãƒ³</button>
    <button onclick="show('lotteryArea')">ğŸ¯<br>ãã˜</button>
    <button onclick="show('historyArea')">ğŸ“„<br>å±¥æ­´</button>
  </div>
</div>

<!-- æ”¯æ‰•ã„ -->
<div id="scannerArea">
  <video id="camera" width="300" autoplay></video>
  <p>é‡‘é¡ï¼š<span id="payAmount">---</span>å††</p>
  <button id="payBtn" onclick="pay()" disabled>æ”¯æ‰•ã„ç¢ºå®š</button>
  <button onclick="closePay()">æˆ»ã‚‹</button>
</div>

<!-- ã‚®ãƒ•ãƒˆ -->
<div id="giftArea">
  <input id="giftInput" placeholder="XXXX-XXXX-0000-1000"><br>
  <input id="giftPass" type="password" placeholder="ç®¡ç†PW"><br>
  <button onclick="gift()">ãƒãƒ£ãƒ¼ã‚¸</button>
  <button onclick="show('homeArea')">æˆ»ã‚‹</button>
</div>

<!-- ã‚¯ãƒ¼ãƒãƒ³ -->
<div id="couponArea">
  <input id="couponInput" placeholder="XXXX-XXXX-0000-0100"><br>
  <input id="couponPass" type="password" placeholder="ç®¡ç†PW"><br>
  <button onclick="addCoupon()">è¿½åŠ </button>
  <div id="couponList"></div>
  <button onclick="show('homeArea')">æˆ»ã‚‹</button>
</div>

<!-- ãã˜ -->
<div id="lotteryArea">
  <button onclick="lottery()">ãã˜ã‚’å¼•ã</button>
  <button onclick="show('homeArea')">æˆ»ã‚‹</button>
</div>

<!-- å±¥æ­´ -->
<div id="historyArea">
  <div id="historyList"></div>
  <button onclick="show('homeArea')">æˆ»ã‚‹</button>
</div>

<script>
/* ===== è¨­å®š ===== */
const API="https://script.google.com/macros/s/AKfycbzYzlqqA7kEgWKQd9hLgIGk1ipGCT5_wAwYNfv7rENe8E6-RS7o0avC_A6TYLFFqzfo/exec";
const ADMIN="21310511";

/* ===== çŠ¶æ…‹ ===== */
let balance = 0;
let coupons = [];
let history = [];
let lastLottery = "";
let stream = null;
let payValue = 0;

/* ===== DOM ===== */
const balanceEl = document.getElementById("balance");
const historyList = document.getElementById("historyList");
const couponList = document.getElementById("couponList");

/* ===== ç”»é¢ ===== */
function show(id){
  document.querySelectorAll('[id$=Area]').forEach(e=>e.style.display="none");
  document.getElementById(id).style.display="block";
}

/* ===== GASé€£å‹• ===== */
function load(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      balance = Number(d.balance)||0;
      coupons = d.coupons||[];
      history = d.history||[];
      lastLottery = d.lastLottery||"";
      update();
    })
    .catch(()=>update());
}

function save(){
  fetch(API,{
    method:"POST",
    body: JSON.stringify({balance,coupons,history,lastLottery})
  });
}

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function update(){
  balanceEl.textContent = balance;
  historyList.innerHTML = history.map(h=>`<div>${h}</div>`).join("");
  couponList.innerHTML = coupons.map((c,i)=>
    `<div class="coupon">${c}å†† <button onclick="delCoupon(${i})">å‰Šé™¤</button></div>`
  ).join("");
}

/* ===== æ©Ÿèƒ½ ===== */
function gift(){
  if(giftPass.value!==ADMIN) return alert("PWé•ã„");
  let m = giftInput.value.match(/-(\d{4})$/);
  if(!m) return;
  let a = Number(m[1]);
  balance += a;
  history.unshift(`ã‚®ãƒ•ãƒˆ +${a}`);
  save(); update(); show("homeArea");
}

function addCoupon(){
  if(couponPass.value!==ADMIN) return;
  let m = couponInput.value.match(/-(\d{4})$/);
  if(!m) return;
  coupons.push(Number(m[1]));
  save(); update();
}

function delCoupon(i){
  coupons.splice(i,1);
  save(); update();
}

function lottery(){
  let t = new Date().toDateString();
  if(t===lastLottery) return alert("ä»Šæ—¥ã¯æ¸ˆã¿");
  lastLottery = t;
  let r = Math.random()*100;
  let a = r<3?2000:r<18?1000:r<68?500:100;
  balance += a;
  history.unshift(`ãã˜ +${a}`);
  save(); update();
}

/* ===== æ”¯æ‰•ã„ ===== */
async function openPay(){
  show("scannerArea");
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  camera.srcObject = stream;
  scan();
}

function closePay(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  show("homeArea");
}

function scan(){
  const c=document.createElement("canvas");
  const x=c.getContext("2d");
  c.width=c.height=300;

  (function loop(){
    if(scannerArea.style.display==="none") return;
    x.drawImage(camera,0,0,300,300);
    let i=x.getImageData(0,0,300,300);
    let q=jsQR(i.data,300,300);
    if(q){
      payValue=Number(q.data);
      payAmount.textContent=payValue;
      payBtn.disabled=false;
      return;
    }
    requestAnimationFrame(loop);
  })();
}

function pay(){
  if(balance<payValue) return alert("æ®‹é«˜ä¸è¶³");
  balance -= payValue;
  history.unshift(`æ”¯æ‰•ã„ -${payValue}`);
  save(); update(); closePay();
}

window.onload = load;
</script>

</body>
</html>
